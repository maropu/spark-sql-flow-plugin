name: Build and test

on:
  push:
    branches:
      - spark-3.2

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [1.8, 11]
        python: [3.7, 3.8]
    env:
      SPARK_LOCAL_IP: localhost
      CONDA_DISABLED: 1
      MAVEN_OPTS: -Xmx1g
    steps:
      - name: Checkout spark-sql-flow-plugin repository
        uses: actions/checkout@v2
        # In order to fetch changed files
        with:
          fetch-depth: 0
      # Cache local repositories. Note that GitHub Actions cache has a 2G limit.
      - name: Cache Scala, Maven and Zinc
        uses: actions/cache@v1
        with:
          path: build
          key: build-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            build-
      - name: Cache Maven local repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ matrix.java }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ matrix.java }}-maven-
      - name: Install JDK ${{ matrix.java }}
        uses: actions/setup-java@v1
        with:
          java-version: ${{ matrix.java }}
      - name: Install Python ${{ matrix.python }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python }}
          architecture: x64
      - name: Install Python packages (Python ${{ matrix.python }})
        run: python -m pip install -r ./bin/requirements.txt
      - name: Install Graphviz
        run: |
          sudo apt-get update -y
          sudo apt-get install -y graphviz
      - name: Run tests
        run: |
          ./build/mvn -q clean package -DskipTests
          ./build/mvn -q test
          ./bin/run-tests --parallelism 1
      - name: Upload test results to report
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: test-results-jdk${{ matrix.java }}-python${{ matrix.python}}
          path: "./target/surefire-reports/*.xml"
      - name: Upload unit tests log files
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: unit-tests-log-jdk${{ matrix.java }}-python${{ matrix.python}}
          path: "./target/unit-tests.log"

  neo4j-integration-tests-java8:
    uses: maropu/spark-sql-flow-plugin/.github/workflows/neo4j_tests.yml@spark-3.2
    with:
      java: 1.8
    secrets:
      uri: ${{ secrets.NEO4J_AURADB_URI}}
      user: ${{ secrets.NEO4J_AURADB_USER}}
      passwd: ${{ secrets.NEO4J_AURADB_PASSWD}}

  neo4j-integration-tests-java11:
    # Since the neo4j integration tests will access the same Neo4j Aura instance,
    # they cannot run concurrently.
    needs: neo4j-integration-tests-java8
    uses: maropu/spark-sql-flow-plugin/.github/workflows/neo4j_tests.yml@spark-3.2
    with:
      java: 11
    secrets:
      uri: ${{ secrets.NEO4J_AURADB_URI}}
      user: ${{ secrets.NEO4J_AURADB_USER}}
      passwd: ${{ secrets.NEO4J_AURADB_PASSWD}}
